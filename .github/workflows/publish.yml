name: Publish

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write
  packages: write

env:
  ZB_TOKEN: ${{ secrets.ZB_TOKEN }}
  NPM_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  READ_TOKEN: ${{ secrets.READ_TOKEN }}
  DISPATCH_TOKEN: ${{ secrets.DISPATCH_TOKEN }}
  SLACK_DEVOPS_NOTIFICATIONS: ${{ secrets.SLACK_DEVOPS_NOTIFICATIONS }}
  SLACK_RELEASES_WEBHOOK: ${{ secrets.SLACK_RELEASES_WEBHOOK }}

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest

    steps:
      - name: Acquire cache v4
        uses: actions/cache@v4
        with:
          path: .git
          key: repo-git-folder

      - name: Check out code v4
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup node v4
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Setup java v3
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'zulu'
      
      - name: Configure git user
        run: |
          git config --global user.email "ci@neverfail.com"
          git config --global user.name "@$GITHUB_ACTOR"

      - name: Install nx
        run: |
          npm install -g nx@20.5.0
        env:
          NPM_TOKEN: ${{ env.NPM_TOKEN }}
          ZB_TOKEN: ${{ env.ZB_TOKEN }}

      - name: Determine base ref for nx affected
        id: base_ref
        run: |
          # Get the last publish tag for nx affected base reference
          LAST_PUBLISH_TAG=$(git describe --tags --abbrev=0 --match="*" 2>/dev/null || echo "")
          if [ -z "$LAST_PUBLISH_TAG" ]; then
            echo "No publish tag found, using origin/main~1 as base"
            echo "BASE_REF=origin/main~1" >> $GITHUB_OUTPUT
          else
            echo "Using last publish tag as base: $LAST_PUBLISH_TAG"
            echo "BASE_REF=$LAST_PUBLISH_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Install and build
        run: |
          npm i
          nx affected -t build --base=${{ steps.base_ref.outputs.BASE_REF }}
        env:
          NPM_TOKEN: ${{ env.NPM_TOKEN }}
          ZB_TOKEN: ${{ env.ZB_TOKEN }}

      - name: Generate bom
        run: |
          nx affected -t generate:bom --base=${{ steps.base_ref.outputs.BASE_REF }}

      - name: Publish
        run: |
          npm run lerna:publish -- --yes
        env:
          ZB_TOKEN: ${{ env.ZB_TOKEN }}
          NPM_TOKEN: ${{ env.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ env.GITHUB_TOKEN }}

      - name: Get published versions
        id: get_package_versions
        run: |
          output=$(./bin/generate_slack_message.sh)
          if [ "$output" = "No packages published" ] || [ -z "$output" ]; then
            echo "has_packages=false" >> $GITHUB_OUTPUT
          else
            echo "has_packages=true" >> $GITHUB_OUTPUT
            echo "output<<EOF" >> $GITHUB_OUTPUT
            echo "$output" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Slack Notification on failure
        uses: slackapi/slack-github-action@v2.1.1
        if: failure()
        with:
          webhook: ${{ env.SLACK_DEVOPS_NOTIFICATIONS }}
          webhook-type: incoming-webhook
          payload: |
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: ":fire: ${{ github.repository }} Github Workflow Failed"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"

      - name: Slack Notification
        uses: slackapi/slack-github-action@v2.1.1
        if: success() && steps.get_package_versions.outputs.has_packages == 'true'
        with:
          webhook: ${{ env.SLACK_RELEASES_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            text: "New ${{ github.repository }} Published"
            attachments:
              - color: "#36a64f"
                fallback: "New Utilities Published"
                title: ":robot: New Utilities Published :tada:"
                text: "${{ steps.get_package_versions.outputs.output }}"
                footer: "<https://github.com/${{ github.repository }}|${{ github.repository }}> â€¢ <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run>"
                mrkdwn_in:
                  - text
                  - footer

  # sbom-recorder:
  #   needs: publish
  #   uses: auditmation/devops/.github/workflows/sbom-recorder.yml@main
  #   secrets: inherit
